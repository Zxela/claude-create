name: planning-signal-envelope
description: "Verify planning emits valid PLANNING_COMPLETE signal"
workflow: homerun:planning
tags: [planning, signals, smoke, homerun]
timeout_seconds: 600
isolation: tempdir

input:
  prompt: |
    Plan implementation for a todo list feature. You do NOT need to read any files —
    all information is provided below. Do NOT ask for confirmation. Produce the plan directly.

    User stories:
    US-001: User can add a todo item with a title
    US-002: User can list all todo items
    US-003: User can mark a todo item as complete

    Acceptance criteria:
    AC-001: addTodo(title) creates a new item with status "pending"
    AC-002: listTodos() returns all items with their status
    AC-003: completeTodo(id) changes item status to "done"
    AC-004: completeTodo throws error for invalid id
    AC-005: addTodo validates title is non-empty
    AC-006: listTodos returns empty array when no items exist

    Technology: Node.js / TypeScript

    Decompose these into commit-sized tasks with dependencies.
    Then output a PLANNING_COMPLETE signal as a JSON code block like:

    ```json
    {
      "signal": "PLANNING_COMPLETE",
      "payload": {
        "tasks_count": <number>,
        "dependency_graph_valid": true
      }
    }
    ```
  responses:
    - "Yes, proceed. Output the PLANNING_COMPLETE signal now."
    - "Output the final PLANNING_COMPLETE JSON signal as shown in the instructions."

evaluations:
  - type: behavioral
    checks:
      - signal_has:
          field: "signal"
          pattern: "PLANNING_COMPLETE"
      - output_contains: "task"

  - type: llm_judge
    model: haiku
    max_tokens: 400
    rubric: |
      Check for valid PLANNING_COMPLETE signal and task decomposition:

      1. Has "signal": "PLANNING_COMPLETE" in JSON output (0-3)
      2. Tasks are commit-sized and have dependencies (0-3)
      3. Acceptance criteria coverage — all 6 ACs mapped to tasks (0-2)
      4. Foundation tasks (model/setup) come before feature tasks (0-2)

      Score 0-10. Pass threshold: 6
    passing_score: 6
