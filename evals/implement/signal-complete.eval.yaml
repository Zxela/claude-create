name: implement-signal-complete
description: "Verify implementer emits valid IMPLEMENTATION_COMPLETE signal"
workflow: homerun:implement
tags: [implement, signals, smoke, homerun]
timeout_seconds: 300
isolation: tempdir

fixtures:
  - path: package.json
    content: |
      {
        "name": "test-project",
        "version": "1.0.0",
        "scripts": { "test": "node --test" }
      }
  - path: src/greeting.ts
    content: |
      // Greeting module stub - implement greet function
      export function greet(name: string): string {
        // TODO: implement
        return '';
      }

input:
  prompt: |
    Implement this task using TDD methodology.

    Task spec:
    {
      "id": "002",
      "title": "Add greeting function",
      "objective": "Create function that returns personalized greeting",
      "task_type": "add_method",
      "methodology": "tdd",
      "acceptance_criteria": [
        {
          "id": "AC-002",
          "criterion": "greet('Alice') returns 'Hello, Alice!'",
          "test_assertion": "expect(greet('Alice')).toBe('Hello, Alice!')"
        }
      ],
      "test_file": "tests/greeting.test.js"
    }

    Create the test file first, then the implementation.
    When done, output an IMPLEMENTATION_COMPLETE signal with files_changed and acceptance_criteria_met.

evaluations:
  - type: behavioral
    checks:
      # Verify signal type - payload field names may vary so LLM judge handles details
      - signal_has:
          field: "signal"
          pattern: "IMPLEMENTATION_COMPLETE"
      - output_contains: "files"

  - type: llm_judge
    model: haiku
    max_tokens: 400
    rubric: |
      Evaluate implementation quality (signal structure already checked by behavioral):

      1. Test-first evidence (0-3): Evidence that test file was created before implementation
      2. AC satisfaction (0-3): The greeting function correctly handles greet('Alice') returning 'Hello, Alice!'
      3. File organization (0-2): Test and implementation are in appropriate locations with clear separation
      4. Completeness (0-2): All required artifacts (test file, implementation file, commit) were produced

      Note: In eval context, the agent may summarize work rather than show full file contents.

      Score 0-10. Pass threshold: 5
    passing_score: 5
