name: implement-blocked-signal
description: "Verify implementer emits IMPLEMENTATION_BLOCKED when dependencies missing"
workflow: homerun:implement
tags: [implement, signals, blocked, homerun]
timeout_seconds: 300
isolation: tempdir

fixtures:
  - path: package.json
    content: |
      {
        "name": "test-project",
        "version": "1.0.0",
        "scripts": { "test": "node --test" }
      }
  - path: src/service.ts
    content: |
      // UserService that depends on User model from task 001
      // Note: User model does NOT exist yet - task 001 not completed
      import { User } from './models/user';

      export class UserService {
        async findById(id: string): Promise<User | null> {
          // Requires User model
          return null;
        }
      }

input:
  prompt: |
    Implement task 003: Add user service methods (SHOULD FAIL - missing User model)

    Task spec:
    {
      "id": "003",
      "title": "Add user service methods",
      "objective": "Create UserService with findById and save methods",
      "task_type": "create_service",
      "depends_on": ["001"],
      "acceptance_criteria": [
        {
          "id": "AC-003",
          "criterion": "UserService.findById returns User instance"
        }
      ],
      "technical_notes": "Requires User model from task 001"
    }

    Note: Task 001 (User model) has NOT been completed. The implementer should detect this.

evaluations:
  - type: behavioral
    checks:
      # Check for blocked signal
      - signal_has:
          field: "signal"
          pattern: "IMPLEMENTATION_BLOCKED"
      - signal_has:
          field: "payload.reason"
      - output_contains: "blocked|dependency|missing"

  - type: llm_judge
    model: haiku
    max_tokens: 400
    rubric: |
      Evaluate blocking behavior quality (signal structure already checked by behavioral):

      1. Dependency analysis (0-4): Correctly identifies that task 001 (User model) is missing and needed
      2. Explanation quality (0-3): Reason is specific about what's missing and why it blocks progress
      3. Recovery guidance (0-3): Provides actionable suggested resolution (e.g., "complete task 001 first")

      If implementation proceeded without blocking: Score 0

      Score 0-10. Pass threshold: 6
    passing_score: 6
