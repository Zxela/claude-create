name: implement-tdd-workflow
description: "Verify implementer follows TDD methodology: red-green-refactor"
workflow: homerun:implement
tags: [implement, tdd, homerun]
timeout_seconds: 600
isolation: tempdir

fixtures:
  - path: package.json
    content: |
      {
        "name": "test-project",
        "version": "1.0.0",
        "scripts": { "test": "node --test" }
      }
  - path: src/user.ts
    content: |
      // User model stub - implement email validation
      export class User {
        constructor(public email: string) {}
      }

input:
  prompt: |
    Implement task 001: Create User model with email validation

    Task spec:
    {
      "id": "001",
      "title": "Create User model with email validation",
      "objective": "Implement User class that validates email format",
      "task_type": "create_model",
      "methodology": "tdd",
      "acceptance_criteria": [
        {
          "id": "AC-001",
          "criterion": "User model validates email format correctly",
          "test_assertion": "expect(User.isValidEmail('bad')).toBe(false)"
        }
      ],
      "test_file": "tests/models/user.test.ts"
    }

evaluations:
  - type: behavioral
    checks:
      # Verify signal envelope for completion
      - signal_has:
          field: "signal"
          pattern: "IMPLEMENTATION_COMPLETE"
      - signal_has:
          field: "source.task_id"
          pattern: "001"
      - signal_has:
          field: "payload.files_changed"
      # Check output mentions TDD steps
      - output_contains: "test"
      - output_contains: "user"

  - type: llm_judge
    model: haiku
    max_tokens: 400
    rubric: |
      Evaluate TDD methodology adherence (signal structure already checked by behavioral):

      1. Red-green-refactor order (0-3): Evidence that test was written before implementation (red phase before green)
      2. Test quality (0-3): Test assertions are meaningful and specific to AC-001, not trivial/tautological
      3. Implementation correctness (0-2): Code actually satisfies the email validation requirement
      4. Separation of concerns (0-2): Test and implementation are in separate files with clear boundaries

      Score 0-10. Pass threshold: 7
    passing_score: 7
